"""
UTILS: LÆ¯U Káº¾T QUáº¢
-------------------

Giáº£i thÃ­ch báº±ng vÃ­ dá»¥ Ä‘á»i sá»‘ng:
- LÆ°u káº¿t quáº£ giá»‘ng nhÆ° ghi láº¡i bÃ i lÃ m
- Khi nÃ o cáº§n xem láº¡i, má»Ÿ file lÃ  Ä‘Æ°á»£c
- KhÃ´ng pháº£i cháº¡y láº¡i code tá»« Ä‘áº§u

Káº¿t quáº£ Ä‘Æ°á»£c lÆ°u:
1. File Markdown: Tá»•ng há»£p má»i thá»© (metrics, config, links)
2. Biá»ƒu Ä‘á»“: PNG vá»›i Ä‘á»™ phÃ¢n giáº£i cao
3. Model: File .keras Ä‘á»ƒ load láº¡i sau
"""

import os
from pathlib import Path
from datetime import datetime
from typing import Dict
import json


def create_results_folder(base_path: str = None, run_type: str = "main") -> Path:
    """
    Táº¡o folder Ä‘á»ƒ lÆ°u káº¿t quáº£
    
    Args:
        base_path: ÄÆ°á»ng dáº«n cÆ¡ sá»Ÿ (máº·c Ä‘á»‹nh: reports/)
        run_type: "main" hoáº·c "notebook"
    
    Returns:
        ÄÆ°á»ng dáº«n Ä‘áº¿n folder káº¿t quáº£
    """
    if base_path is None:
        base_path = Path(__file__).parent.parent / "reports"
    else:
        base_path = Path(base_path)
    
    # Táº¡o timestamp
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    
    # TÃªn folder: run_type/BiLSTM_YYYYMMDD_HHMMSS
    folder_path = base_path / run_type / f"BiLSTM_{timestamp}"
    folder_path.mkdir(parents=True, exist_ok=True)
    
    return folder_path


def save_markdown_report(
    folder_path: Path,
    config: Dict,
    metrics: Dict,
    history: Dict = None,
    plots: Dict = None
):
    """
    LÆ°u bÃ¡o cÃ¡o tá»•ng há»£p dÆ°á»›i dáº¡ng Markdown
    
    Args:
        folder_path: ThÆ° má»¥c lÆ°u bÃ¡o cÃ¡o
        config: Cáº¥u hÃ¬nh cháº¡y
        metrics: Káº¿t quáº£ Ä‘Ã¡nh giÃ¡
        history: Training history
        plots: Dict chá»©a tÃªn file cá»§a cÃ¡c plot
    """
    report_path = folder_path / f"results_BiLSTM_{folder_path.name.replace('BiLSTM_', '')}.md"
    
    # Táº¡o ná»™i dung Markdown
    content = f"""# Káº¿t quáº£ dá»± Ä‘oÃ¡n giÃ¡ Bitcoin - BiLSTM

**Timestamp:** {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}

---

## ğŸ“Š Metrics

| Metric | GiÃ¡ trá»‹ |
|--------|---------|
| MAE (Sai sá»‘ trung bÃ¬nh) | ${metrics.get('mae', 0):.2f} |
| RMSE (SÄƒn báº­c 2 sai sá»‘) | ${metrics.get('rmse', 0):.2f} |
| MAPE (Sai sá»‘ pháº§n trÄƒm) | {metrics.get('mape', 0):.2f}% |

---

## âš™ï¸ Cáº¥u hÃ¬nh

| Tham sá»‘ | GiÃ¡ trá»‹ |
|---------|---------|
| Symbol | {config.get('symbol', 'BTC/USDT')} |
| Timeframe | {config.get('timeframe', '1d')} |
| Data limit | {config.get('limit', 1500)} |
| Window size | {config.get('window_size', 60)} |
| Epochs | {config.get('epochs', 20)} |
| LSTM units | {config.get('lstm_units', [64, 32])} |
| Dropout rate | {config.get('dropout_rate', 0.2)} |

---

## ğŸ“ˆ Training History
"""
    
    # ThÃªm training history náº¿u cÃ³
    if history:
        final_epoch = len(history.get('loss', []))
        content += f"""
| Epoch | Train Loss | Val Loss | Train MAE | Val MAE |
|-------|------------|----------|-----------|---------|
"""
        for i in range(final_epoch):
            content += f"| {i+1} | {history['loss'][i]:.6f} | {history['val_loss'][i]:.6f} | {history['mae'][i]:.4f} | {history['val_mae'][i]:.4f} |\n"
    
    # ThÃªm plots náº¿u cÃ³
    if plots:
        content += "\n---\n\n## ğŸ“Š Biá»ƒu Ä‘á»“\n\n"
        if 'training_history' in plots:
            content += f"- [Training History](training_history_{plots['training_history']}.png)\n"
        if 'predictions' in plots:
            content += f"- [Predictions vs Actual](predictions_{plots['predictions']}.png)\n"
        if 'all_in_one' in plots:
            content += f"- [All-in-one Summary](all_in_one_{plots['all_in_one']}.png)\n"
    
    content += "\n---\n\n*Generated by BiLSTM Bitcoin Price Prediction Model*"
    
    # LÆ°u file
    with open(report_path, 'w', encoding='utf-8') as f:
        f.write(content)
    
    print(f"ğŸ’¾ ÄÃ£ lÆ°u bÃ¡o cÃ¡o Markdown: {report_path}")
    return report_path


def save_config(folder_path: Path, config: Dict):
    """
    LÆ°u cáº¥u hÃ¬nh vÃ o file JSON
    
    Args:
        folder_path: ThÆ° má»¥c lÆ°u file
        config: Dict cáº¥u hÃ¬nh
    """
    config_path = folder_path / "config.json"
    
    with open(config_path, 'w', encoding='utf-8') as f:
        json.dump(config, f, indent=2, ensure_ascii=False)
    
    print(f"ğŸ’¾ ÄÃ£ lÆ°u cáº¥u hÃ¬nh: {config_path}")


def save_metrics(folder_path: Path, metrics: Dict):
    """
    LÆ°u metrics vÃ o file JSON
    
    Args:
        folder_path: ThÆ° má»¥c lÆ°u file
        metrics: Dict metrics (cÃ³ thá»ƒ chá»©a numpy arrays)
    """
    import numpy as np
    
    metrics_path = folder_path / "metrics.json"
    
    # Chuyá»ƒn numpy arrays sang lists Ä‘á»ƒ JSON serialize
    metrics_json = {}
    for key, value in metrics.items():
        if isinstance(value, np.ndarray):
            metrics_json[key] = value.tolist()
        elif isinstance(value, (np.integer, np.floating)):
            metrics_json[key] = float(value)
        else:
            metrics_json[key] = value
    
    with open(metrics_path, 'w', encoding='utf-8') as f:
        json.dump(metrics_json, f, indent=2)
    
    print(f"ğŸ’¾ ÄÃ£ lÆ°u metrics: {metrics_path}")


def clean_old_reports(base_path: str = None, keep: int = 5):
    """
    XÃ³a cÃ¡c bÃ¡o cÃ¡o cÅ©, chá»‰ giá»¯ láº¡i `keep` folder má»›i nháº¥t
    
    Args:
        base_path: ÄÆ°á»ng dáº«n cÆ¡ sá»Ÿ
        keep: Sá»‘ folder cáº§n giá»¯ láº¡i
    
    Returns:
        Sá»‘ folder Ä‘Ã£ xÃ³a
    """
    if base_path is None:
        base_path = Path(__file__).parent.parent / "reports"
    else:
        base_path = Path(base_path)
    
    deleted_count = 0
    
    # Duyá»‡t qua cÃ¡c thÆ° má»¥c con (main, notebook)
    for run_type_dir in base_path.iterdir():
        if not run_type_dir.is_dir():
            continue
        
        # Láº¥y danh sÃ¡ch cÃ¡c folder káº¿t quáº£, sáº¯p xáº¿p theo thá»i gian giáº£m dáº§n
        result_folders = sorted(run_type_dir.glob("BiLSTM_*"), key=lambda x: x.stat().st_mtime, reverse=True)
        
        # XÃ³a cÃ¡c folder cÅ© hÆ¡n `keep`
        for folder in result_folders[keep:]:
            import shutil
            shutil.rmtree(folder)
            deleted_count += 1
    
    if deleted_count > 0:
        print(f"ğŸ—‘ï¸  ÄÃ£ xÃ³a {deleted_count} bÃ¡o cÃ¡o cÅ© (giá»¯ láº¡i {keep} má»›i nháº¥t)")
    else:
        print("âœ… KhÃ´ng cÃ³ bÃ¡o cÃ¡o nÃ o Ä‘á»ƒ xÃ³a")
    
    return deleted_count


if __name__ == "__main__":
    # Test functions
    folder = create_results_folder()
    print(f"ÄÃ£ táº¡o folder káº¿t quáº£: {folder}")
    
    # Test save markdown
    config = {
        'symbol': 'BTC/USDT',
        'timeframe': '1d',
        'limit': 1500,
        'window_size': 60,
        'epochs': 20
    }
    
    metrics = {
        'mae': 500.0,
        'rmse': 700.0,
        'mape': 1.5
    }
    
    history = {
        'loss': [0.1, 0.08, 0.06],
        'val_loss': [0.12, 0.09, 0.07],
        'mae': [100, 80, 60],
        'val_mae': [120, 90, 70]
    }
    
    save_markdown_report(folder, config, metrics, history)
    save_config(folder, config)
    save_metrics(folder, metrics)
